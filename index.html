import React, { useState, useEffect, useRef } from 'react';
import { 
  Timer, CheckCircle, AlertCircle, RefreshCcw, HelpCircle, 
  Trophy, Camera, Loader2, Play, FileText, ClipboardList, 
  ChevronLeft, Sparkles, BookOpen, Database, Trash2 
} from 'lucide-react';

// Main App Component
const App = () => {
  // --- STATE MANAGEMENT ---
  // Game Modes: menu, playing, won, lost, scanning, input_text, explanation, library
  const [gameState, setGameState] = useState('menu'); 
  const [timeLeft, setTimeLeft] = useState(0);
  const [activeCell, setActiveCell] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [customText, setCustomText] = useState('');
  const [activeCase, setActiveCase] = useState(1); // Case 1 or Case 2 logic
  
  // Library State
  const [library, setLibrary] = useState([]);
  
  // File Input Ref
  const fileInputRef = useRef(null);

  // Current Level Data & User Progress
  const [levelData, setLevelData] = useState(null);
  const [userAnswers, setUserAnswers] = useState({ case1: {}, case2: {} });
  const [aiExplanation, setAiExplanation] = useState('');
  const [currentLevelId, setCurrentLevelId] = useState(null); // To track which level is being played

  const apiKey = ""; // Runtime provides the key

  // --- LOCAL STORAGE INITIALIZATION ---
  useEffect(() => {
    const savedLibrary = localStorage.getItem('puzzleVault');
    if (savedLibrary) {
      setLibrary(JSON.parse(savedLibrary));
    }
  }, []);

  // --- SAVE TO LIBRARY FUNCTION ---
  const saveToLibrary = (data) => {
    const newLevelNumber = library.length + 1;
    const newEntry = {
      id: Date.now(), // Unique ID based on timestamp
      levelNumber: newLevelNumber,
      title: data.title || `Puzzle #${newLevelNumber}`,
      data: data,
      date: new Date().toLocaleDateString()
    };
    
    const updatedLibrary = [...library, newEntry];
    setLibrary(updatedLibrary);
    localStorage.setItem('puzzleVault', JSON.stringify(updatedLibrary));
    return newEntry.id;
  };

  // --- DELETE FROM LIBRARY ---
  const deleteLevel = (id, e) => {
    e.stopPropagation();
    if (window.confirm("Kya aap is level ko delete karna chahte hain?")) {
      const updatedLibrary = library.filter(item => item.id !== id);
      // Re-indexing levels (Optional, keeping ID consistent is better but for user view re-numbering)
      const reindexedLibrary = updatedLibrary.map((item, index) => ({
        ...item,
        levelNumber: index + 1
      }));
      setLibrary(reindexedLibrary);
      localStorage.setItem('puzzleVault', JSON.stringify(reindexedLibrary));
    }
  };

  // --- API CALL WITH BACKOFF ---
  const callGeminiAPI = async (payload, retries = 5, delay = 1000) => {
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('API request failed');
      return await response.json();
    } catch (error) {
      if (retries > 0) {
        await new Promise(res => setTimeout(res, delay));
        return callGeminiAPI(payload, retries - 1, delay * 2);
      }
      throw error;
    }
  };

  // --- AI LOGIC PARSER ---
  const processWithAI = async (content, isImage = false) => {
    setIsAiLoading(true);
    setGameState('scanning');

    const prompt = `Analyze this reasoning puzzle ${isImage ? 'image' : 'text'}. 
    Identify names, attributes (fields), options, and hints.
    Return strictly JSON format:
    {
      "title": "Short Descriptive Title",
      "names": ["Name1", "Name2"...],
      "fields": ["Field1", "Field2"...],
      "options": { "Field1": ["Opt1", "Opt2"...], "Field2": [...] },
      "hints": ["Hint 1", "Hint 2"...],
      "solution": { "Name1": {"Field1": "Val", "Field2": "Val"}, ... },
      "explanation": "Provide a step-by-step logic guide in Hinglish. Act like a competitive exam mentor. Mention 'Shortcut' tips, which hint to pick first, and how to eliminate cases."
    }
    Important: Ensure names and options arrays match in size. If it's a floor puzzle, add 'Floor' as a field.`;

    try {
      const payload = {
        contents: [{
          parts: [
            { text: prompt },
            isImage 
              ? { inlineData: { mimeType: "image/png", data: content.split(',')[1] } }
              : { text: `Puzzle Text: ${content}` }
          ]
        }]
      };

      const result = await callGeminiAPI(payload);
      const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
      const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error("Could not parse AI response");
      
      const parsedData = JSON.parse(jsonMatch[0]);
      
      // Auto-save to Library
      const savedId = saveToLibrary(parsedData);
      
      setAiExplanation(parsedData.explanation);
      setupGame(parsedData, savedId);
    } catch (error) {
      console.error(error);
      alert("AI Error: Text clear nahi hai. Kripya dobara try karein.");
      setGameState('menu');
    } finally {
      setIsAiLoading(false);
    }
  };

  // --- GAME SETUP ---
  const setupGame = (data, levelId = null) => {
    const emptyAnswers = {};
    data.names.forEach(name => {
      emptyAnswers[name] = {};
      data.fields.forEach(field => {
        emptyAnswers[name][field] = '';
      });
    });
    
    setUserAnswers({ 
      case1: JSON.parse(JSON.stringify(emptyAnswers)), 
      case2: JSON.parse(JSON.stringify(emptyAnswers)) 
    });
    
    setLevelData(data);
    setAiExplanation(data.explanation); // Load explanation if available in library
    setCurrentLevelId(levelId);
    
    // Timer Logic: 90s per person
    setTimeLeft(data.names.length * 90); 
    setGameState('playing');
  };

  // --- FILE UPLOAD ---
  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => processWithAI(reader.result, true);
      reader.readAsDataURL(file);
    }
  };

  // --- TIMER ---
  useEffect(() => {
    if (gameState !== 'playing' || timeLeft <= 0) return;
    const timer = setInterval(() => setTimeLeft(prev => (prev <= 1 ? 0 : prev - 1)), 1000);
    return () => clearInterval(timer);
  }, [gameState, timeLeft]);

  useEffect(() => {
    if (timeLeft === 0 && gameState === 'playing') setGameState('lost');
  }, [timeLeft, gameState]);

  // --- INTERACTION HANDLERS ---
  const handleSelect = (value) => {
    if (!activeCell) return;
    const { name, field } = activeCell;
    const currentCaseKey = activeCase === 1 ? 'case1' : 'case2';
    setUserAnswers(prev => ({
      ...prev,
      [currentCaseKey]: {
        ...prev[currentCaseKey],
        [name]: { ...prev[currentCaseKey][name], [field]: value }
      }
    }));
    setActiveCell(null);
  };

  const checkSolution = () => {
    const currentAnswers = activeCase === 1 ? userAnswers.case1 : userAnswers.case2;
    let isCorrect = true;
    levelData.names.forEach(name => {
      levelData.fields.forEach(field => {
        if (currentAnswers[name][field] !== levelData.solution[name][field]) isCorrect = false;
      });
    });

    if (isCorrect) setGameState('won');
    else alert("Logic match nahi hua. Hints check karein.");
  };

  const currentCaseData = activeCase === 1 ? userAnswers.case1 : userAnswers.case2;

  // --- UI SCREENS ---

  // 1. MAIN MENU
  if (gameState === 'menu') {
    return (
      <div className="min-h-screen bg-[#050505] text-white p-6 flex flex-col items-center justify-center font-sans">
        <div className="fixed -top-20 -left-20 w-64 h-64 bg-blue-600/20 rounded-full blur-[100px]" />
        <div className="relative z-10 w-full max-w-sm flex flex-col items-center">
          <div className="w-24 h-24 bg-gradient-to-tr from-blue-600 to-indigo-500 rounded-[2.5rem] flex items-center justify-center mb-6 shadow-2xl border-4 border-white/5 animate-pulse">
            <Sparkles size={40} className="text-white" />
          </div>
          <h1 className="text-5xl font-black mb-2 tracking-tighter italic bg-gradient-to-br from-white to-slate-400 bg-clip-text text-transparent">LOGIC.AI</h1>
          <p className="text-slate-500 text-sm mb-10 font-bold uppercase tracking-widest text-center">Exam Prep Terminal</p>
          
          <div className="w-full space-y-4">
            <button onClick={() => setGameState('input_text')} className="w-full bg-white text-black p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all shadow-xl group">
              <div className="p-2 bg-slate-100 rounded-full group-hover:bg-slate-200"><FileText size={20} /></div>
              <span className="text-lg">Paste Question</span>
            </button>
            <button onClick={() => fileInputRef.current.click()} className="w-full bg-slate-900 border border-white/10 p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all group">
              <div className="p-2 bg-slate-800 rounded-full group-hover:bg-slate-700"><Camera size={20} className="text-blue-500" /></div>
              <span className="text-lg">Scan from Book</span>
            </button>
            <button onClick={() => setGameState('library')} className="w-full bg-slate-900 border border-white/10 p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all group">
              <div className="p-2 bg-slate-800 rounded-full group-hover:bg-slate-700"><Database size={20} className="text-green-500" /></div>
              <div className="flex flex-col text-left">
                <span className="text-lg">Memory Vault</span>
                <span className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Total Levels: {library.length}</span>
              </div>
            </button>
            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept="image/*" className="hidden" />
          </div>
        </div>
      </div>
    );
  }

  // 2. LIBRARY / MEMORY VAULT
  if (gameState === 'library') {
    return (
      <div className="min-h-screen bg-[#050505] p-6 text-white flex flex-col items-center">
        <div className="w-full max-w-md pt-6 flex flex-col h-full">
          <button onClick={() => setGameState('menu')} className="mb-6 text-blue-500 font-black uppercase text-xs flex items-center gap-1 self-start">
            <ChevronLeft size={16} /> Main Menu
          </button>
          <div className="flex justify-between items-end mb-6">
            <h2 className="text-4xl font-black italic tracking-tighter">Vault</h2>
            <span className="text-sm font-bold text-slate-500 bg-white/5 px-3 py-1 rounded-full border border-white/5">{library.length} Puzzles</span>
          </div>
          
          {library.length === 0 ? (
            <div className="flex flex-col items-center justify-center flex-1 text-center opacity-50 mt-20">
              <Database size={64} className="mb-4 text-slate-600" />
              <p className="text-lg font-bold">No Puzzles Saved</p>
              <p className="text-xs text-slate-500 uppercase tracking-widest mt-2">Paste or scan a question to start building your library.</p>
            </div>
          ) : (
            <div className="space-y-3 overflow-y-auto pb-20 custom-scrollbar">
              {library.slice().reverse().map((level) => (
                <div key={level.id} onClick={() => setupGame(level.data, level.id)} className="bg-white/5 border border-white/10 p-5 rounded-[2rem] active:scale-95 transition-all cursor-pointer hover:bg-white/10 group relative">
                  <div className="flex justify-between items-start">
                    <div>
                      <span className="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-1">Level {level.levelNumber}</span>
                      <h3 className="text-lg font-bold leading-tight line-clamp-1">{level.title}</h3>
                      <p className="text-xs text-slate-500 mt-2 font-mono">{level.date}</p>
                    </div>
                    <button 
                      onClick={(e) => deleteLevel(level.id, e)}
                      className="p-3 bg-slate-900 rounded-full text-slate-600 hover:text-red-500 transition-colors z-10"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                  <div className="absolute right-4 bottom-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <Play size={20} className="text-white" fill="white" />
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  // 3. INPUT TEXT
  if (gameState === 'input_text') {
    return (
      <div className="min-h-screen bg-[#050505] p-6 text-white flex flex-col items-center">
        <div className="w-full max-w-md pt-6">
          <button onClick={() => setGameState('menu')} className="mb-8 text-blue-500 font-black uppercase text-xs flex items-center gap-1">
            <ChevronLeft size={16} /> Back
          </button>
          <h2 className="text-4xl font-black mb-6 italic tracking-tighter">Input Data</h2>
          <textarea 
            className="w-full h-80 bg-white/5 border border-white/10 rounded-[2.5rem] p-8 text-slate-200 focus:outline-none focus:border-blue-500 transition-all resize-none font-medium placeholder:text-slate-700"
            placeholder="Paste your reasoning puzzle text here..."
            value={customText}
            onChange={(e) => setCustomText(e.target.value)}
          />
          <button 
            disabled={!customText.trim()}
            onClick={() => processWithAI(customText)}
            className="w-full mt-8 bg-blue-600 disabled:opacity-50 p-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition-all"
          >
            GENERATE & SAVE
          </button>
        </div>
      </div>
    );
  }

  // 4. SCANNING LOADER
  if (gameState === 'scanning') {
    return (
      <div className="min-h-screen bg-[#050505] flex flex-col items-center justify-center text-center p-10 text-white">
        <Loader2 size={64} className="text-blue-500 animate-spin mb-8" />
        <h2 className="text-3xl font-black italic tracking-tighter">AI ANALYZING</h2>
        <p className="text-slate-500 mt-2 font-bold uppercase text-[10px] tracking-widest">Saving to Vault...</p>
      </div>
    );
  }

  // 5. MAIN GAME (PLAYING)
  return (
    <div className="min-h-screen bg-[#050505] text-white font-sans p-4 flex flex-col items-center pb-40 overflow-x-hidden">
      {/* Header */}
      <div className="w-full max-w-md bg-white/5 backdrop-blur-xl p-5 rounded-[2.5rem] border border-white/10 mb-6 flex justify-between items-center shadow-2xl">
        <div className="flex flex-col overflow-hidden max-w-[60%]">
          <div className="flex items-center gap-2">
            <span className="text-[10px] font-black bg-white/10 px-2 py-0.5 rounded text-slate-400">LVL {library.find(l => l.data === levelData)?.levelNumber || '?'}</span>
            <h2 className="text-xs font-black text-blue-400 uppercase tracking-widest truncate">{levelData?.title || 'Practice'}</h2>
          </div>
          <div className="flex gap-2 mt-2">
            <button onClick={() => setActiveCase(1)} className={`px-4 py-1.5 rounded-full text-[10px] font-black transition-all ${activeCase === 1 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/5 text-slate-500'}`}>CASE 1</button>
            <button onClick={() => setActiveCase(2)} className={`px-4 py-1.5 rounded-full text-[10px] font-black transition-all ${activeCase === 2 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/5 text-slate-500'}`}>CASE 2</button>
          </div>
        </div>
        <div className={`text-2xl font-mono font-black ${timeLeft < 60 ? 'text-red-500 animate-pulse' : 'text-blue-400'}`}>
          {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
        </div>
      </div>

      {/* Hints Card */}
      <div className="w-full max-w-md bg-white/[0.02] border border-white/10 rounded-[2.5rem] p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
           <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Logic Clues</span>
           <BookOpen size={16} className="text-blue-500 opacity-50" />
        </div>
        <div className="space-y-4 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
          {levelData?.hints.map((h, i) => (
            <p key={i} className="text-sm text-slate-300 font-medium leading-relaxed border-l-2 border-blue-500/30 pl-3">{h}</p>
          ))}
        </div>
      </div>

      {/* Grid */}
      <div className="w-full max-w-md bg-white/[0.01] rounded-[2.5rem] border border-white/10 overflow-hidden mb-8 shadow-2xl">
        <div className="overflow-x-auto scrollbar-hide">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-white/5">
                <th className="p-5 text-[10px] font-black text-slate-500 uppercase text-left sticky left-0 bg-[#050505] z-10 border-r border-white/5">Name</th>
                {levelData?.fields.map(f => <th key={f} className="p-5 text-[10px] font-black text-slate-500 uppercase text-center min-w-[140px]">{f}</th>)}
              </tr>
            </thead>
            <tbody>
              {levelData?.names.map(name => (
                <tr key={name} className="border-b border-white/5 last:border-0 hover:bg-white/[0.01]">
                  <td className="p-5 font-black text-white bg-[#050505] sticky left-0 text-sm border-r border-white/5">{name}</td>
                  {levelData?.fields.map(field => (
                    <td key={field} onClick={() => setActiveCell({ name, field })} className="p-3">
                      <div className={`h-14 rounded-2xl flex items-center justify-center text-[10px] font-black uppercase border transition-all ${currentCaseData[name]?.[field] ? 'bg-blue-600/10 border-blue-500/40 text-blue-400' : 'bg-white/5 border-transparent text-slate-800'}`}>
                        {currentCaseData[name]?.[field] || 'Tap'}
                      </div>
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Bottom Controls */}
      <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black via-black/95 to-transparent z-[50]">
        <div className="max-w-md mx-auto grid grid-cols-4 gap-4">
          <button onClick={() => setGameState('menu')} className="bg-slate-900 h-16 rounded-[1.5rem] flex items-center justify-center border border-white/5 active:scale-90 transition-all">
            <RefreshCcw size={24} className="text-slate-500" />
          </button>
          <button onClick={checkSolution} className="col-span-3 bg-white text-black h-16 rounded-[1.5rem] flex items-center justify-center gap-3 font-black text-lg active:scale-95 transition-all shadow-xl">
            <CheckCircle size={24} /> CHECK
          </button>
        </div>
      </div>

      {/* Selection Drawer */}
      {activeCell && (
        <div className="fixed inset-0 bg-black/95 z-[100] flex items-end justify-center p-4">
          <div className="bg-[#0f0f0f] w-full max-w-md rounded-[3rem] p-8 border border-white/10 animate-in slide-in-from-bottom duration-500">
             <div className="w-12 h-1 bg-white/10 rounded-full mx-auto mb-8" />
             <h3 className="text-3xl font-black mb-1 text-white">{activeCell.name}</h3>
             <p className="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-8">Set {activeCell.field}</p>
             <div className="grid grid-cols-2 gap-4 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar">
               {levelData?.options[activeCell.field].map(opt => (
                 <button key={opt} onClick={() => handleSelect(opt)} className={`p-6 rounded-2xl text-[11px] font-black border-2 transition-all flex items-center justify-center text-center ${currentCaseData[activeCell.name][activeCell.field] === opt ? 'bg-white border-white text-black' : 'bg-slate-900 border-white/5 text-slate-500'}`}>
                   {opt}
                 </button>
               ))}
             </div>
             <button onClick={() => setActiveCell(null)} className="w-full mt-6 py-4 text-slate-600 font-black uppercase text-[10px] tracking-widest">Close</button>
          </div>
        </div>
      )}

      {/* Win/Loss Modal */}
      {(gameState === 'won' || gameState === 'lost') && (
        <div className="fixed inset-0 bg-[#050505] z-[200] flex flex-col items-center justify-center p-10 text-center animate-in zoom-in duration-300">
           {gameState === 'won' ? (
             <>
               <Trophy size={80} className="text-white mb-6 animate-bounce" />
               <h2 className="text-6xl font-black italic mb-4">SOLVED!</h2>
               <p className="text-slate-500 mb-12">Level Complete. Saved to Vault.</p>
             </>
           ) : (
             <>
               <AlertCircle size={80} className="text-red-500 mb-6" />
               <h2 className="text-6xl font-black text-red-500 italic mb-4">TIMEOUT!</h2>
               <p className="text-slate-500 mb-12">Time khatam. Explanation dekhein.</p>
             </>
           )}
           <div className="w-full max-w-xs space-y-4">
             <button onClick={() => setGameState('explanation')} className="w-full bg-white/10 border border-white/10 p-5 rounded-[2rem] text-white font-black flex items-center justify-center gap-2">
               <BookOpen size={20} /> VIEW MENTOR GUIDE
             </button>
             <button onClick={() => setGameState('menu')} className="w-full bg-blue-600 p-5 rounded-[2rem] text-white font-black text-xl shadow-xl shadow-blue-500/20">MAIN MENU</button>
           </div>
        </div>
      )}

      {/* Explanation View */}
      {gameState === 'explanation' && (
        <div className="fixed inset-0 bg-[#050505] z-[300] p-8 flex flex-col text-white">
          <button onClick={() => setGameState('menu')} className="mb-8 text-blue-500 font-black uppercase text-xs flex items-center gap-1">
            <ChevronLeft size={16} /> Exit
          </button>
          <h2 className="text-4xl font-black italic mb-2">Mentor Guide</h2>
          <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6">Shortcut Analysis</p>
          <div className="bg-white/5 p-8 rounded-[2.5rem] border border-white/10 text-slate-300 leading-relaxed font-medium whitespace-pre-wrap overflow-y-auto max-h-[60vh] custom-scrollbar shadow-inner text-sm italic">
            {aiExplanation || "Explanation loading..."}
          </div>
          <button onClick={() => setGameState('menu')} className="mt-8 bg-blue-600 p-6 rounded-[2rem] font-black text-xl shadow-xl">BACK TO MENU</button>
        </div>
      )}
    </div>
  );
};

export default App;