import React, { useState, useEffect, useRef } from 'react';
import { 
  Timer, CheckCircle, AlertCircle, RefreshCcw, HelpCircle, 
  Trophy, Camera, Loader2, Play, FileText, ClipboardList, 
  ChevronLeft, Sparkles, BookOpen, Database, Trash2, Settings, Save
} from 'lucide-react';

// Main App Component
const App = () => {
  // --- STATE MANAGEMENT ---
  const [gameState, setGameState] = useState('menu'); 
  const [timeLeft, setTimeLeft] = useState(0);
  const [activeCell, setActiveCell] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [customText, setCustomText] = useState('');
  const [activeCase, setActiveCase] = useState(1);
  
  // API Key and Library
  const [apiKey, setApiKey] = useState('');
  const [tempKey, setTempKey] = useState('');
  const [library, setLibrary] = useState([]);
  
  const fileInputRef = useRef(null);
  const [levelData, setLevelData] = useState(null);
  const [userAnswers, setUserAnswers] = useState({ case1: {}, case2: {} });
  const [aiExplanation, setAiExplanation] = useState('');

  // --- LOCAL STORAGE INITIALIZATION ---
  useEffect(() => {
    const savedLibrary = localStorage.getItem('puzzleVault');
    if (savedLibrary) setLibrary(JSON.parse(savedLibrary));

    const savedKey = localStorage.getItem('geminiApiKey');
    if (savedKey) {
      setApiKey(savedKey);
      setTempKey(savedKey);
    }
  }, []);

  // --- SETTINGS LOGIC ---
  const handleSaveSettings = () => {
    localStorage.setItem('geminiApiKey', tempKey);
    setApiKey(tempKey);
    setGameState('menu');
  };

  // --- LIBRARY LOGIC ---
  const saveToLibrary = (data) => {
    const newLevelNumber = library.length + 1;
    const newEntry = {
      id: Date.now(),
      levelNumber: newLevelNumber,
      title: data.title || `Puzzle #${newLevelNumber}`,
      data: data,
      date: new Date().toLocaleDateString()
    };
    
    const updatedLibrary = [...library, newEntry];
    setLibrary(updatedLibrary);
    localStorage.setItem('puzzleVault', JSON.stringify(updatedLibrary));
    return newEntry.id;
  };

  const deleteLevel = (id, e) => {
    e.stopPropagation();
    const updatedLibrary = library.filter(item => item.id !== id).map((item, index) => ({
      ...item,
      levelNumber: index + 1
    }));
    setLibrary(updatedLibrary);
    localStorage.setItem('puzzleVault', JSON.stringify(updatedLibrary));
  };

  // --- API CALL ---
  const callGeminiAPI = async (payload, retries = 5, delay = 1000) => {
    if (!apiKey) {
      setGameState('settings');
      throw new Error("API Key Missing");
    }
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('API request failed');
      return await response.json();
    } catch (error) {
      if (retries > 0 && error.message !== "API Key Missing") {
        await new Promise(res => setTimeout(res, delay));
        return callGeminiAPI(payload, retries - 1, delay * 2);
      }
      throw error;
    }
  };

  // --- AI PROCESS ---
  const processWithAI = async (content, isImage = false) => {
    setIsAiLoading(true);
    setGameState('scanning');

    const prompt = `Analyze this reasoning puzzle ${isImage ? 'image' : 'text'}. Return strictly JSON:
    { "title": "Title", "names": [], "fields": [], "options": {}, "hints": [], "solution": {}, "explanation": "Hinglish guide" }`;

    try {
      const payload = {
        contents: [{
          parts: [
            { text: prompt },
            isImage 
              ? { inlineData: { mimeType: "image/png", data: content.split(',')[1] } }
              : { text: `Puzzle Text: ${content}` }
          ]
        }]
      };

      const result = await callGeminiAPI(payload);
      const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
      const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
      const parsedData = JSON.parse(jsonMatch[0]);
      
      const savedId = saveToLibrary(parsedData);
      setupGame(parsedData, savedId);
    } catch (error) {
      if (error.message !== "API Key Missing") {
        alert("AI processing fail ho gaya. Kripya clear text ya image use karein.");
        setGameState('menu');
      }
    } finally {
      setIsAiLoading(false);
    }
  };

  const setupGame = (data, levelId = null) => {
    const emptyAnswers = {};
    data.names.forEach(name => {
      emptyAnswers[name] = {};
      data.fields.forEach(field => emptyAnswers[name][field] = '');
    });
    setUserAnswers({ case1: JSON.parse(JSON.stringify(emptyAnswers)), case2: JSON.parse(JSON.stringify(emptyAnswers)) });
    setLevelData(data);
    setAiExplanation(data.explanation);
    setTimeLeft(data.names.length * 90); 
    setGameState('playing');
  };

  // --- TIMER ---
  useEffect(() => {
    if (gameState !== 'playing' || timeLeft <= 0) return;
    const timer = setInterval(() => setTimeLeft(prev => (prev <= 1 ? 0 : prev - 1)), 1000);
    return () => clearInterval(timer);
  }, [gameState, timeLeft]);

  const handleSelect = (value) => {
    const key = activeCase === 1 ? 'case1' : 'case2';
    setUserAnswers(prev => ({
      ...prev,
      [key]: { ...prev[key], [activeCell.name]: { ...prev[key][activeCell.name], [activeCell.field]: value } }
    }));
    setActiveCell(null);
  };

  const checkSolution = () => {
    const currentAnswers = activeCase === 1 ? userAnswers.case1 : userAnswers.case2;
    let isCorrect = true;
    levelData.names.forEach(name => {
      levelData.fields.forEach(field => {
        if (currentAnswers[name][field] !== levelData.solution[name][field]) isCorrect = false;
      });
    });
    if (isCorrect) setGameState('won');
    else alert("Logic match nahi hua. Hints dobara check karein.");
  };

  // --- UI RENDER ---

  if (gameState === 'menu') return (
    <div className="min-h-screen bg-[#050505] text-white p-6 flex flex-col items-center justify-center font-sans">
      <button onClick={() => setGameState('settings')} className="fixed top-6 right-6 p-3 bg-white/5 rounded-full text-slate-400 active:bg-white/10">
        <Settings size={24} />
      </button>
      <div className="w-24 h-24 bg-gradient-to-tr from-blue-600 to-indigo-500 rounded-[2.5rem] flex items-center justify-center mb-6 shadow-2xl animate-pulse">
        <Sparkles size={40} className="text-white" />
      </div>
      <h1 className="text-5xl font-black mb-2 tracking-tighter italic">LOGIC.AI</h1>
      <p className="text-slate-500 text-sm mb-10 font-bold tracking-widest uppercase">Exam Prep Vault</p>
      <div className="w-full max-w-sm space-y-4">
        <button onClick={() => setGameState('input_text')} className="w-full bg-white text-black p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all"><FileText size={20} /> Paste Question</button>
        <button onClick={() => fileInputRef.current.click()} className="w-full bg-slate-900 border border-white/10 p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all"><Camera size={20} className="text-blue-500" /> Scan Book</button>
        <button onClick={() => setGameState('library')} className="w-full bg-slate-900 border border-white/10 p-6 rounded-[2rem] font-black flex items-center gap-4 active:scale-95 transition-all"><Database size={20} className="text-green-500" /> Memory Vault ({library.length})</button>
        <input type="file" ref={fileInputRef} onChange={e => {const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=()=>processWithAI(r.result,true); r.readAsDataURL(f);}}} className="hidden" accept="image/*" />
      </div>
    </div>
  );

  if (gameState === 'settings') return (
    <div className="min-h-screen bg-[#050505] p-6 text-white flex flex-col items-center justify-center">
      <div className="w-full max-w-md">
        <button onClick={() => setGameState('menu')} className="mb-8 text-blue-500 font-black uppercase text-xs flex items-center gap-1"><ChevronLeft size={16} /> Back</button>
        <h2 className="text-4xl font-black mb-6 tracking-tighter italic">Settings</h2>
        <div className="bg-white/5 border border-white/10 rounded-[2rem] p-6 mb-6">
          <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Gemini API Key</label>
          <input 
            type="password" 
            value={tempKey} 
            onChange={e => setTempKey(e.target.value)} 
            placeholder="Paste your key here..."
            className="w-full bg-black/50 border border-white/10 p-4 rounded-xl text-sm font-mono focus:border-blue-500 outline-none"
          />
          <p className="mt-4 text-[10px] text-slate-600 leading-relaxed font-bold uppercase">Required for AI processing. Get it free at aistudio.google.com</p>
        </div>
        <button onClick={handleSaveSettings} className="w-full bg-blue-600 p-6 rounded-[2rem] font-black text-xl flex items-center justify-center gap-2 active:scale-95 transition-all"><Save size={20}/> Save Settings</button>
      </div>
    </div>
  );

  if (gameState === 'library') return (
    <div className="min-h-screen bg-[#050505] p-6 text-white flex flex-col items-center">
      <div className="w-full max-w-md pt-6">
        <button onClick={() => setGameState('menu')} className="mb-6 text-blue-500 font-black uppercase text-xs flex items-center gap-1"><ChevronLeft size={16} /> Menu</button>
        <h2 className="text-4xl font-black mb-6 italic tracking-tighter">Vault</h2>
        <div className="space-y-3 overflow-y-auto pb-20 custom-scrollbar max-h-[70vh]">
          {library.slice().reverse().map(l => (
            <div key={l.id} onClick={() => setupGame(l.data, l.id)} className="bg-white/5 border border-white/10 p-5 rounded-[2rem] flex justify-between items-center active:scale-95 transition-all">
              <div>
                <span className="text-[10px] font-black text-blue-500 uppercase">Level {l.levelNumber}</span>
                <h3 className="font-bold leading-tight">{l.title}</h3>
              </div>
              <button onClick={e => deleteLevel(l.id, e)} className="p-3 text-slate-600 hover:text-red-500"><Trash2 size={18}/></button>
            </div>
          ))}
          {library.length === 0 && <div className="text-center p-20 opacity-30 font-bold uppercase text-xs">No Puzzles Found</div>}
        </div>
      </div>
    </div>
  );

  if (gameState === 'input_text') return (
    <div className="min-h-screen bg-[#050505] p-6 text-white flex flex-col items-center">
      <div className="w-full max-w-md">
        <button onClick={() => setGameState('menu')} className="mb-8 text-blue-500 font-black uppercase text-xs flex items-center gap-1"><ChevronLeft size={16} /> Back</button>
        <h2 className="text-4xl font-black mb-6 italic tracking-tighter">New Puzzle</h2>
        <textarea 
          value={customText} 
          onChange={e=>setCustomText(e.target.value)} 
          className="w-full h-80 bg-white/5 border border-white/10 rounded-[2rem] p-8 text-slate-200 focus:outline-none focus:border-blue-500 resize-none font-medium" 
          placeholder="Paste puzzle text here..."
        />
        <button onClick={() => processWithAI(customText)} className="w-full mt-6 bg-blue-600 p-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition-all">Generate & Save</button>
      </div>
    </div>
  );

  if (gameState === 'scanning') return (
    <div className="min-h-screen bg-[#050505] flex flex-col items-center justify-center text-center p-10 text-white">
      <Loader2 size={64} className="text-blue-500 animate-spin mb-8" />
      <h2 className="text-3xl font-black italic tracking-tighter uppercase">AI Brainstorming</h2>
      <p className="text-slate-500 mt-2 font-bold uppercase text-[10px] tracking-widest">Building your mission...</p>
    </div>
  );

  const currentCaseData = activeCase === 1 ? userAnswers.case1 : userAnswers.case2;

  return (
    <div className="min-h-screen bg-[#050505] text-white font-sans p-4 flex flex-col items-center pb-40 overflow-x-hidden">
      <div className="w-full max-w-md bg-white/5 backdrop-blur-xl p-5 rounded-[2.5rem] border border-white/10 mb-6 flex justify-between items-center shadow-2xl">
        <div className="flex flex-col overflow-hidden max-w-[60%]">
          <h2 className="text-xs font-black text-blue-400 uppercase tracking-widest truncate">{levelData?.title || 'Practice'}</h2>
          <div className="flex gap-2 mt-2">
            <button onClick={() => setActiveCase(1)} className={`px-4 py-1.5 rounded-full text-[10px] font-black transition-all ${activeCase === 1 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/5 text-slate-500'}`}>CASE 1</button>
            <button onClick={() => setActiveCase(2)} className={`px-4 py-1.5 rounded-full text-[10px] font-black transition-all ${activeCase === 2 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/5 text-slate-500'}`}>CASE 2</button>
          </div>
        </div>
        <div className="text-2xl font-mono font-black text-blue-400">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
      </div>

      <div className="w-full max-w-md bg-white/[0.02] border border-white/10 rounded-[2.5rem] p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
           <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Logic Clues</span>
           <BookOpen size={16} className="text-blue-500 opacity-50" />
        </div>
        <div className="space-y-4 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
          {levelData?.hints.map((h, i) => <p key={i} className="text-sm text-slate-300 font-medium leading-relaxed border-l-2 border-blue-500/30 pl-3">{h}</p>)}
        </div>
      </div>

      <div className="w-full max-w-md bg-white/[0.01] rounded-[2.5rem] border border-white/10 overflow-hidden mb-8 shadow-2xl">
        <div className="overflow-x-auto scrollbar-hide">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-white/5">
                <th className="p-5 text-[10px] font-black text-slate-500 uppercase text-left sticky left-0 bg-[#050505] z-10 border-r border-white/5">Name</th>
                {levelData?.fields.map(f => <th key={f} className="p-5 text-[10px] font-black text-slate-500 uppercase text-center min-w-[140px]">{f}</th>)}
              </tr>
            </thead>
            <tbody>
              {levelData?.names.map(name => (
                <tr key={name} className="border-b border-white/5 last:border-0 hover:bg-white/[0.01]">
                  <td className="p-5 font-black text-white bg-[#050505] sticky left-0 text-sm border-r border-white/5">{name}</td>
                  {levelData?.fields.map(field => (
                    <td key={field} onClick={() => setActiveCell({ name, field })} className="p-3">
                      <div className={`h-14 rounded-2xl flex items-center justify-center text-[10px] font-black uppercase border transition-all ${currentCaseData[name]?.[field] ? 'bg-blue-600/10 border-blue-500/40 text-blue-400' : 'bg-white/5 border-transparent text-slate-800'}`}>{currentCaseData[name]?.[field] || 'Tap'}</div>
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black via-black/95 to-transparent z-[50]">
        <div className="max-w-md mx-auto grid grid-cols-4 gap-4">
          <button onClick={() => setGameState('menu')} className="bg-slate-900 h-16 rounded-[1.5rem] flex items-center justify-center border border-white/5 active:scale-90 transition-all"><RefreshCcw size={24} className="text-slate-500" /></button>
          <button onClick={checkSolution} className="col-span-3 bg-white text-black h-16 rounded-[1.5rem] flex items-center justify-center gap-3 font-black text-lg shadow-2xl active:scale-95 transition-all"><CheckCircle size={24} /> CHECK MISSION</button>
        </div>
      </div>

      {activeCell && (
        <div className="fixed inset-0 bg-black/95 z-[100] flex items-end justify-center p-4">
          <div className="bg-[#0f0f0f] w-full max-w-md rounded-[3rem] p-8 border border-white/10 animate-in slide-in-from-bottom duration-500">
             <div className="w-12 h-1 bg-white/10 rounded-full mx-auto mb-8" />
             <h3 className="text-3xl font-black mb-1">{activeCell.name}</h3>
             <p className="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-8">Set {activeCell.field}</p>
             <div className="grid grid-cols-2 gap-4 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar text-white">
               {levelData?.options[activeCell.field].map(opt => (
                 <button key={opt} onClick={() => handleSelect(opt)} className={`p-6 rounded-2xl text-[11px] font-black border-2 transition-all flex items-center justify-center text-center ${currentCaseData[activeCell.name][activeCell.field] === opt ? 'bg-white border-white text-black shadow-lg shadow-white/10' : 'bg-slate-900 border-white/5 text-slate-500'}`}>{opt}</button>
               ))}
             </div>
             <button onClick={() => setActiveCell(null)} className="w-full mt-6 py-4 text-slate-600 font-black uppercase text-[10px] tracking-widest">Close</button>
          </div>
        </div>
      )}

      {(gameState === 'won' || gameState === 'lost') && (
        <div className="fixed inset-0 bg-[#050505] z-[200] flex flex-col items-center justify-center p-10 text-center animate-in zoom-in duration-300">
           {gameState === 'won' ? (
             <>
               <Trophy size={80} className="text-white mb-6 animate-bounce" />
               <h2 className="text-6xl font-black italic mb-4 uppercase">Success</h2>
               <p className="text-slate-500 mb-12 uppercase text-[10px] font-black tracking-widest">Level Decoded Perfectly</p>
             </>
           ) : (
             <>
               <AlertCircle size={80} className="text-red-500 mb-6" />
               <h2 className="text-6xl font-black text-red-500 italic mb-4 uppercase">Timeout</h2>
               <p className="text-slate-500 mb-12 uppercase text-[10px] font-black tracking-widest">Analyze the explanation</p>
             </>
           )}
           <div className="w-full max-w-xs space-y-4">
             <button onClick={() => setGameState('explanation')} className="w-full bg-white/10 border border-white/10 p-5 rounded-[2rem] text-white font-black flex items-center justify-center gap-2 uppercase text-xs tracking-widest"><BookOpen size={18} /> View Guide</button>
             <button onClick={() => setGameState('menu')} className="w-full bg-blue-600 p-5 rounded-[2rem] text-white font-black text-xl shadow-xl shadow-blue-500/20 uppercase tracking-tighter">Main Menu</button>
           </div>
        </div>
      )}

      {gameState === 'explanation' && (
        <div className="fixed inset-0 bg-[#050505] z-[300] p-8 flex flex-col text-white">
          <button onClick={() => setGameState('menu')} className="mb-8 text-blue-500 font-black uppercase text-xs flex items-center gap-1"><ChevronLeft size={16} /> Exit</button>
          <h2 className="text-4xl font-black italic mb-2 tracking-tighter">Mentor Guide</h2>
          <div className="bg-white/5 p-8 rounded-[2.5rem] border border-white/10 text-slate-300 leading-relaxed font-medium whitespace-pre-wrap overflow-y-auto max-h-[60vh] custom-scrollbar italic text-sm">{aiExplanation}</div>
          <button onClick={() => setGameState('menu')} className="mt-8 bg-blue-600 p-6 rounded-[2rem] font-black text-xl uppercase tracking-tighter">Back to Terminal</button>
        </div>
      )}
    </div>
  );
};

export default App;
